---
name: prules
description: 在执行任何编码任务时使用此 skill，确保遵循用户的个人编码习惯和工作流程要求
invocable: true
---
# 个人编码标准和工作流程

## When to use this skill

**必须在以下情况下使用此 skill：**

- 用户请求编写、修改或重构任何代码
- 用户请求实现新功能
- 用户请求修复 bug
- 用户请求进行代码审查
- 任何涉及代码变更的任务

**重要：此 skill 应该在每次编码任务开始时自动应用，无需用户明确调用。**

---

## 🎯 工作模式配置

prules 支持两种工作模式：

### 模式 1：交互模式（默认）

**每个关键阶段都需要用户确认后才能继续：**

- ✋ **阶段 1 完成后**：展示技术方案和任务清单，等待用户确认
- ✋ **阶段 2 完成后**：展示测试用例，等待用户确认
- ✋ **阶段 3 完成后**：展示实现代码，等待用户确认
- ✋ **阶段 4 完成后**：展示最终结果，等待用户确认

### 模式 2：自动模式

**用户可以通过以下方式启用自动模式：**

1. **在请求中包含关键词**：
   - `auto` / `自动` / `automatic`
   - `no confirm` / `不要确认` / `skip confirmation`
   - `直接执行` / `just do it`

2. **创建配置文件**：在项目根目录创建 `.claude/prules.local.md`：
   ```yaml
   ---
   mode: auto
   ---
   ```

**自动模式下的行为：**
- ✅ 自动完成所有阶段，无需等待确认
- ✅ 仍然会展示每个阶段的输出，但不会暂停
- ✅ 遇到错误或测试失败时会自动回滚并重试
- ✅ 完成后展示完整的执行报告

---

## 核心工作流程（必须严格遵循）

### 阶段 1：需求理解和头脑风暴 ✋

在开始任何编码工作之前，**必须**先进行头脑风暴：

1. **理解需求**

   - 仔细分析用户的需求
   - 识别潜在的边界情况和约束条件
   - 明确成功标准

2. **技术方案设计**

   - 考虑多种实现方案
   - 评估每种方案的优缺点
   - 选择最符合用户编码标准的方案

3. **任务规划**

   - 将任务拆分成尽可能细粒度的子任务
   - 每个子任务应该是独立的、可测试的、可回滚的
   - 使用 TodoWrite 工具创建详细的任务清单
   - 任务粒度要足够细，方便 debug 和回滚

4. **📋 阶段 1 输出**

   向用户展示：
   - 需求分析总结
   - 技术方案说明（包括技术栈选择、架构设计）
   - 详细的任务清单（使用 TodoWrite 创建）
   - 预期的实现步骤

5. **✋ 确认点**

   **交互模式**：等待用户确认方案后再继续
   - 用户可以要求调整方案
   - 用户可以要求细化某些任务
   - 用户确认后才进入阶段 2

   **自动模式**：展示输出后自动继续

### 阶段 2：测试驱动开发（TDD） ✋

**关键原则：测试先行，代码后行**

1. **编写测试用例**

   - 在编写任何实现代码之前，先编写测试
   - 测试应该覆盖：正常情况、边界情况、异常情况、错误处理

2. **测试文件组织**

   - 为每个模块/类/函数创建对应的测试文件
   - 测试文件命名清晰，易于识别

3. **运行测试**

   - 确保新测试最初是失败的（红灯）
   - 这验证了测试确实在测试新功能

4. **📋 阶段 2 输出**

   向用户展示：
   - 创建的测试文件列表
   - 测试用例的详细说明
   - 测试覆盖的场景（正常、边界、异常）
   - 测试运行结果（应该是红灯/失败）

5. **✋ 确认点**

   **交互模式**：等待用户确认测试用例后再继续
   - 用户可以要求添加更多测试场景
   - 用户可以要求调整测试策略
   - 用户确认后才进入阶段 3

   **自动模式**：展示输出后自动继续

### 阶段 3：实现代码 ✋

1. **版本控制准备**

   - 在开始实现前，确保当前代码已提交到 git
   - 创建清晰的 commit 记录作为回滚点
   - 考虑使用 git branch 进行功能开发

2. **编写实现代码**

   - 遵循编码标准（详见参考文件）
   - 每完成一个小的功能点就运行测试
   - 保持小步迭代

3. **迭代验证**

   - 每次代码变更后立即运行测试
   - **测试必须通过才能继续下一步**
   - 如果测试失败：
     - 分析失败原因
     - 修复代码或修正测试
     - 如果无法快速修复，使用 `git reset --hard` 或 `git checkout` 回滚到上一个稳定版本
     - 重新规划实现方案

4. **📋 阶段 3 输出**

   向用户展示：
   - 实现的代码文件列表
   - 关键代码片段和说明
   - 测试运行结果（应该是绿灯/通过）
   - Git 提交记录
   - 遇到的问题和解决方案

5. **✋ 确认点**

   **交互模式**：等待用户确认实现后再继续
   - 用户可以要求调整实现细节
   - 用户可以要求优化代码
   - 用户确认后才进入阶段 4

   **自动模式**：展示输出后自动继续

### 阶段 4：完成和验证 ✋

1. **最终测试**

   - 运行完整的测试套件
   - 确保所有测试通过
   - 检查测试覆盖率

2. **代码审查**

   - 自我审查代码质量
   - 确保符合所有编码标准
   - 检查是否有遗漏的注释或文档

3. **记录变更（必须）**

   - **更新 CHANGELOG.md**：记录本次变更的详细信息
     - 变更类型（新增功能、修复bug、重构、文档更新等）
     - 变更内容描述
     - 影响范围
     - 相关文件列表
   - **更新相关文档**：确保文档与代码同步
     - 如果是新功能，创建对应的功能文档
     - 如果修改了现有功能，更新对应的功能文档
     - 保持需求文档（README.md）为唯一的总体需求说明
     - 每个功能模块维护独立的功能文档

4. **文档组织规范（必须遵循）**

   - **需求文档**：只维护一份 `README.md` 或 `REQUIREMENTS.md`
     - 包含项目整体需求、目标、架构说明
     - 不包含具体功能的详细实现说明

   - **功能文档**：每个功能模块维护独立的文档
     - 位置：`docs/features/` 目录下
     - 命名：`功能名称.md`（如 `用户注册.md`、`数据导出.md`）
     - 内容：功能详细说明、API 接口、使用示例、注意事项

   - **变更日志**：维护 `CHANGELOG.md`
     - 按时间倒序记录所有变更
     - 使用标准格式（日期、版本、变更类型、详细说明）

5. **提交代码（必须）**

   - **Git 提交要求**：
     - 编写清晰的 commit message（使用约定式提交格式）
     - 说明做了什么改动和为什么
     - 每次提交必须包含：
       - 代码变更
       - 相关测试
       - 文档更新（如果有）
       - CHANGELOG.md 更新

   - **提交前检查清单**：
     - [ ] 所有测试通过
     - [ ] 代码符合编码标准
     - [ ] 注释完整且使用中文
     - [ ] CHANGELOG.md 已更新
     - [ ] 相关文档已更新或创建
     - [ ] 文档组织符合规范（一份需求文档 + 多份功能文档）

4. **📋 阶段 4 输出**

   向用户展示：
   - 完整的测试报告（所有测试通过）
   - 代码审查结果
   - **CHANGELOG.md 更新内容**
   - **文档更新列表**（新增或修改的功能文档）
   - 最终的 Git 提交记录
   - 功能演示或使用说明
   - 完成的任务清单总结

5. **✋ 确认点**

   **交互模式**：等待用户最终确认
   - 用户可以要求进行额外的测试
   - 用户可以要求补充文档
   - 用户确认后任务完成

   **自动模式**：展示输出，任务自动完成

---

## 编码标准（必须遵循）

### 1. 代码注释规范

**核心要求：**

- **所有注释必须使用中文**
- **详细注释每个类、方法和复杂逻辑**

**详细规范请参考：** `.claude/skills/prules/coding-standards/comments-guide.md`

需要时使用 Read 工具读取该文件获取详细的注释示例和要求。

### 2. 错误处理规范

**核心要求：**

- **详细的异常处理 + 日志记录 + 用户友好提示**
- **每个可能出错的操作都要有 try-catch 包裹**
- **所有错误都要记录到日志系统**

**详细规范请参考：** `.claude/skills/prules/coding-standards/error-handling-guide.md`

需要时使用 Read 工具读取该文件获取详细的错误处理示例和要求。

### 3. 代码组织规范

**核心要求：**

- **模块化 + 简洁实用 + 面向对象**
- **遵循 SOLID 原则**
- **避免过度设计**

**详细规范请参考：** `.claude/skills/prules/coding-standards/code-organization-guide.md`

需要时使用 Read 工具读取该文件获取详细的代码组织示例和要求。

### 4. Git 版本管理规范

**核心要求：**

- **频繁提交，每个小功能完成后立即 commit**
- **测试失败时使用 git 回滚到上一个稳定版本**
- **使用清晰的 commit message**

**详细规范请参考：** `.claude/skills/prules/coding-standards/git-workflow-guide.md`

需要时使用 Read 工具读取该文件获取详细的 Git 工作流程和命令。

---

## 工作流程检查清单

**详细检查清单请参考：** `.claude/skills/prules/coding-standards/workflow-checklist.md`

### 快速检查

**开始前：**

- [ ] 理解需求 → 头脑风暴 → 拆分任务 → 确认方案

**实现中：**

- [ ] Git 提交（回滚点）→ 写测试 → 测试失败（红灯）→ 写代码 → 测试通过（绿灯）

**完成后：**

- [ ] 运行所有测试 → 代码审查 → 最终提交

---

## 重要提醒

1. **测试先行是强制要求**：任何实现代码之前必须先有测试
2. **测试不通过不能继续**：如果测试失败，必须修复或回滚
3. **任务拆分要细**：越细越好，方便 debug 和回滚
4. **Git 是安全网**：频繁提交，随时可以回滚
5. **注释必须详细且使用中文**：让代码易于理解和维护
6. **错误处理必须完整**：包括日志记录和用户友好提示
7. **代码组织要清晰**：模块化、面向对象、简洁实用

---

## 参考文件索引

当需要详细的编码规范时，使用 Read 工具读取以下文件：

- **注释规范：** `.claude/skills/prules/coding-standards/comments-guide.md`
- **错误处理：** `.claude/skills/prules/coding-standards/error-handling-guide.md`
- **代码组织：** `.claude/skills/prules/coding-standards/code-organization-guide.md`
- **Git 工作流：** `.claude/skills/prules/coding-standards/git-workflow-guide.md`
- **检查清单：** `.claude/skills/prules/coding-standards/workflow-checklist.md`

---

## 示例工作流程

### 示例 1：交互模式（默认）

<example>
用户: 帮我实现一个用户注册功能

助手: 好的，我来帮你实现用户注册功能。我将使用 prules 标准，按照 4 个阶段进行。

---

**🔍 阶段 1：需求理解和头脑风暴**

**需求分析：**
用户注册功能需要包含：

1. 输入验证（用户名、邮箱、密码）
2. 检查用户是否已存在
3. 密码加密
4. 保存到数据库
5. 错误处理和日志记录
6. 返回友好的提示信息

**技术方案：**

- 使用面向对象的方式组织代码，创建 UserService 类
- 使用 bcrypt 进行密码加密
- 实现详细的异常处理和日志记录
- 所有注释使用中文

**任务拆分：**
[使用 TodoWrite 创建任务清单]

1. 创建 UserService 类的测试文件
2. 编写用户注册功能的测试用例
3. 实现 UserService 类的基本结构
4. 实现输入验证逻辑
5. 实现用户存在性检查
6. 实现密码加密
7. 实现数据库保存
8. 实现错误处理和日志记录
9. 运行测试并确保通过
10. 代码审查和提交

**✋ 这个方案符合你的要求吗？请确认后我将开始编写测试用例。**

[等待用户确认...]

用户: 确认，继续

---

**🧪 阶段 2：测试驱动开发**

[编写测试用例...]

**测试文件：** `tests/test_user_service.py`

**测试覆盖场景：**
- ✅ 正常注册流程
- ✅ 用户名已存在
- ✅ 邮箱格式无效
- ✅ 密码强度不足
- ✅ 数据库连接失败

**测试运行结果：** ❌ 5 个测试全部失败（预期行为，因为还没有实现）

**✋ 测试用例已准备好，请确认后我将开始实现代码。**

[等待用户确认...]

用户: 看起来不错，继续

---

**💻 阶段 3：实现代码**

[实现代码...]

**实现的文件：**
- `src/services/user_service.py` - UserService 类
- `src/utils/validators.py` - 输入验证工具
- `src/utils/crypto.py` - 密码加密工具

**测试运行结果：** ✅ 5 个测试全部通过

**Git 提交记录：**
- `test: 添加用户注册功能测试用例`
- `feat: 实现用户注册功能`

**✋ 实现已完成，所有测试通过。请确认后我将进行最终验证。**

[等待用户确认...]

用户: 很好，继续

---

**✅ 阶段 4：完成和验证**

**最终测试报告：**
- ✅ 所有单元测试通过（5/5）
- ✅ 测试覆盖率：95%
- ✅ 代码审查通过

**代码质量检查：**
- ✅ 所有类和方法都有中文注释
- ✅ 完整的错误处理和日志记录
- ✅ 遵循面向对象设计原则

**最终提交：**
- `docs: 添加用户注册功能文档`

**✋ 用户注册功能已完成！所有测试通过，代码已提交。**

</example>

---

### 示例 2：自动模式

<example>
用户: 帮我实现一个用户注册功能，auto 模式

助手: 好的，我将使用 prules 自动模式实现用户注册功能。

---

**🔍 阶段 1：需求理解和头脑风暴**

[展示需求分析、技术方案、任务拆分...]

**✅ 自动继续到阶段 2**

---

**🧪 阶段 2：测试驱动开发**

[展示测试用例、测试结果...]

**✅ 自动继续到阶段 3**

---

**💻 阶段 3：实现代码**

[展示实现代码、测试结果、Git 提交...]

**✅ 自动继续到阶段 4**

---

**✅ 阶段 4：完成和验证**

[展示最终测试报告、代码审查结果...]

**🎉 任务完成！用户注册功能已实现并通过所有测试。**

</example>

---

## 适用语言

此标准适用于所有编程语言，包括但不限于：

- Python
- JavaScript/TypeScript
- Java
- C#
- Go
- Rust
- 等等

根据具体语言的特性和惯例进行适当调整，但核心原则保持不变。
